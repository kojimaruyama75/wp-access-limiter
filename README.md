# WP Access Limiter

WordPress管理画面への同時アクセス数を制限するプラグイン

## 概要

WP Access Limiterは、WordPress管理画面への同時ログインユーザー数を制限し、サーバー負荷を軽減するためのプラグインです。特に共有サーバー環境や複数のユーザーが管理画面にアクセスする環境での負荷対策に有効です。

## 主な機能

### ✅ 実装済み機能

- **同時アクセス数の制限**: 設定可能な上限値による同時ログイン制御
- **管理者除外設定**: 管理者権限ユーザーを制限から除外する機能
- **リアルタイムモニタリング**: 現在のアクティブユーザー一覧表示
- **セッション管理**: データベースベースの堅牢なセッション追跡
- **手動切断機能**: 管理画面からのユーザーセッション強制切断
- **自動クリーンアップ**: 30分以上非アクティブなセッションの自動削除
- **IPアドレス記録**: セキュリティ監査のためのアクセス元記録
- **Ajax対応UI**: リアルタイムでのアクティブユーザー情報更新

### 🔧 設定可能項目

- **最大同時ログインユーザー数**: 1〜100名まで設定可能
- **管理者除外フラグ**: 管理者権限者を上限カウントから除外
- **制限メッセージ**: アクセス制限時の表示メッセージカスタマイズ

## インストール方法

1. プラグインファイル（`wp-access-limiter.php`）をWordPressの `wp-content/plugins/wp-access-limiter/` ディレクトリに配置
2. WordPress管理画面の「プラグイン」メニューから「WP Access Limiter」を有効化
3. 「設定」>「アクセス制限」から設定を行う

## 技術仕様

### データベース構造

プラグイン有効化時に `{prefix}_access_limiter_sessions` テーブルが作成されます：

```sql
CREATE TABLE wp_access_limiter_sessions (
    id mediumint(9) NOT NULL AUTO_INCREMENT,
    user_id bigint(20) NOT NULL,
    session_id varchar(255) NOT NULL,
    login_time datetime DEFAULT CURRENT_TIMESTAMP NOT NULL,
    last_activity datetime DEFAULT CURRENT_TIMESTAMP NOT NULL,
    ip_address varchar(100) NOT NULL,
    user_agent text NOT NULL,
    PRIMARY KEY (id),
    KEY user_id (user_id),
    KEY session_id (session_id)
);
```

### セッション管理

- **セッション識別**: PHPセッションIDを使用
- **タイムアウト**: 30分間非アクティブで自動削除
- **更新頻度**: 管理画面アクセス時に毎回更新
- **クリーンアップ**: admin_init時に期限切れセッションを削除

### セキュリティ機能

- **IPアドレス取得**: プロキシ対応の多段階IP検出
- **ユーザーエージェント記録**: デバイス・ブラウザ情報の保存
- **権限チェック**: 設定変更は `manage_options` 権限必要
- **データサニタイズ**: 全入力データの適切なエスケープ処理

## 動作フロー

### ログイン時の制限チェック

1. **管理者除外チェック**: 設定で管理者除外が有効 & ユーザーが管理者権限を持つ場合はスキップ
2. **既存セッション確認**: 同一ユーザーの既存セッションがある場合は更新して継続
3. **上限チェック**: アクティブセッション数が上限に達している場合はアクセス拒否
4. **新規セッション作成**: 問題なければ新しいセッション情報をDBに記録

### セッション更新プロセス

- 管理画面アクセス時に `last_activity` を現在時刻で更新
- IP アドレスとユーザーエージェントも最新情報に更新
- 30分以上前のセッションは自動削除

## 既知の制限事項・考慮点

### 🔍 検証が必要な項目

1. **同一ユーザーの複数ログイン**: 
   - 現状: 既存セッションを更新する仕様
   - 検討点: 同一ユーザーの別デバイスからのログインをどう扱うか

2. **セッションID衝突リスク**:
   - PHPセッションIDの一意性に依存
   - 異なるサーバー・環境での重複可能性

3. **ブラウザタブ間の制御**:
   - 同一ユーザーの複数タブでの動作
   - タブクローズ時のセッション残存問題

4. **ロードバランサー環境での動作**:
   - 複数サーバー環境でのセッション同期
   - sticky session が必要な可能性

### ⚠️ 運用上の注意点

- **Ajax処理の実装不完全**: `disconnect_user` アクションの実装が不足
- **エラーハンドリング**: データベースエラー時のフォールバック処理
- **パフォーマンス**: 大量セッション時のクエリ性能
- **国際化対応**: 日本語ハードコード、多言語対応未実装

## 今後の改善項目

### 優先度 高
- [ ] `disconnect_user` Ajax処理の実装
- [ ] データベースエラー時のエラーハンドリング強化
- [ ] 同一ユーザー複数デバイス時の動作仕様明確化

### 優先度 中
- [ ] 国際化対応（.pot/.po/.mo ファイル）
- [ ] 設定画面のUX改善
- [ ] セッション監査ログ機能

### 優先度 低
- [ ] 詳細なアクセス統計機能
- [ ] 時間帯別制限機能
- [ ] 管理者通知機能

## 開発環境

- **WordPress**: 5.0以上
- **PHP**: 7.4以上推奨
- **データベース**: MySQL 5.7以上 / MariaDB 10.3以上

## ライセンス

GPL-2.0+

## サポート・問い合わせ

技術的な質問やバグ報告は、本リポジトリのIssuesにて受け付けています。

---

## 開発者向け情報

### Devin連携準備

このプラグインは今後、AI開発ツール「Devin」との連携による品質向上・機能拡張を予定しています。

**対象期間**: 2025年7-9月  
**主な作業項目**:
- 詳細仕様書の作成
- 包括的テストケースの設計・実装
- 既知問題の修正・改善
- コードリファクタリング

開発環境セットアップやコントリビューション方法については、後日 `CONTRIBUTING.md` で詳細を公開予定です。
